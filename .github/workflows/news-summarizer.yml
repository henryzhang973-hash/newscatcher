name: News Summarizer

on:
  schedule:
    # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    # åŒ—äº¬æ—¶é—´ï¼š8:00, 16:00, 0:00ï¼ˆæ¬¡æ—¥ï¼‰
    - cron: "0 */8 * * *"
  workflow_dispatch:

concurrency:
  group: news-summarizer
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  summarize:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify configuration
        run: |
          echo "=========================================="
          echo "é…ç½®éªŒè¯"
          echo "=========================================="
          echo ""
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo ""
          echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          if [ ! -f config.yaml ]; then
            echo "âŒ é”™è¯¯: config.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            echo "æŸ¥æ‰¾çš„æ–‡ä»¶: $(pwd)/config.yaml"
            exit 1
          fi
          echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨: config.yaml"
          echo ""
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ Secrets..."
          if [ -z "${{ secrets.AI_API_KEY }}" ]; then
            echo "âŒ é”™è¯¯: AI_API_KEY æœªé…ç½®"
            echo "è¯·åœ¨ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ  AI_API_KEY"
            exit 1
          fi
          echo "âœ… AI_API_KEY å·²é…ç½®"
          
          if [ -z "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
            echo "âŒ é”™è¯¯: FEISHU_WEBHOOK_URL æœªé…ç½®"
            echo "è¯·åœ¨ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ  FEISHU_WEBHOOK_URL"
            exit 1
          fi
          echo "âœ… FEISHU_WEBHOOK_URL å·²é…ç½®"
          
          if [ -z "${{ secrets.AI_BASE_URL }}" ]; then
            echo "âš ï¸  è­¦å‘Š: AI_BASE_URL æœªé…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼"
          else
            echo "âœ… AI_BASE_URL å·²é…ç½®: ${{ secrets.AI_BASE_URL }}"
          fi
          
          if [ -z "${{ secrets.AI_MODEL }}" ]; then
            echo "âš ï¸  è­¦å‘Š: AI_MODEL æœªé…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼"
          else
            echo "âœ… AI_MODEL å·²é…ç½®: ${{ secrets.AI_MODEL }}"
          fi
          
          echo ""
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          echo "=========================================="
      
      - name: Run news summarizer
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER || 'openai' }}
          AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TOP_N: ${{ secrets.TOP_N || '10' }}
        run: |
          echo "=========================================="
          echo "å¼€å§‹è¿è¡Œæ–°é—»æ€»ç»“ç¨‹åº"
          echo "=========================================="
          echo ""
          echo "ç¯å¢ƒå˜é‡æ£€æŸ¥ï¼š"
          echo "  AI_API_KEY: ${AI_API_KEY:0:10}... (å·²è®¾ç½®)"
          echo "  AI_PROVIDER: ${AI_PROVIDER:-æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼ openai}"
          echo "  AI_BASE_URL: ${AI_BASE_URL:-æœªè®¾ç½®}"
          echo "  AI_MODEL: ${AI_MODEL:-æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼}"
          echo "  FEISHU_WEBHOOK_URL: ${FEISHU_WEBHOOK_URL:0:30}... (å·²è®¾ç½®)"
          echo "  TOP_N: ${TOP_N:-10}"
          echo ""
          python main.py

